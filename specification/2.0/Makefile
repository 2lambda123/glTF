# Copyright 2020 The Khronos Group Inc.
# SPDX-License-Identifier: Apache-2.0

# Output specification targets
SPEC = Specification
TARGETS = $(SPEC).html $(SPEC).pdf
all: $(TARGETS)

# Generate the Properties Reference section of the spec from JSON schema.
# This uses 'npx' to minimally install the 'wetzel' tool, if needed.
# When using embedded schemas, SCHEMALINK should be a relative path.

WETZEL = npx wetzel
SCHEMALINK = schema
EMBEDSCHEMA = JsonSchemaReference.adoc

# Base name of the generated properties reference file
PROPREF = PropertiesReference
# Files generated by wetzel
GENERATED = $(PROPREF).adoc $(EMBEDSCHEMA)
# Schema files to leave out of $(PROPREF)
IGNORESCHEMA = '["gltfchildofrootproperty.schema.json", "gltfid.schema.json", "gltfproperty.schema.json"]'
$(GENERATED): $(wildcard schema/*.json)
	$(WETZEL) -n -a=cqo -m=a -p "$(SCHEMALINK)" -e "$(EMBEDSCHEMA)" \
	    -i $(IGNORESCHEMA) \
	    schema/glTF.schema.json > $(PROPREF).adoc

# Spec targets for offline generation
# Requires an up-to-date asciidoctor and asciidoctor-pdf be installed
# We recommend using the khronosgroup/vulkan-docs-base image on dockerhub
ASCIIDOCTOR = asciidoctor
SPECDEPS = $(SPEC).adoc $(GENERATED)

$(SPEC).html: $(SPECDEPS)
	$(ASCIIDOCTOR) -b html5 $(SPEC).adoc -o $@

# :allow-url-read: is necessary for the embedded render.githubusers.com
# math images to be processed for the PDF target. See
# https://github.com/asciidoctor/asciidoctor-pdf/issues/369
$(SPEC).pdf: $(SPECDEPS)
	$(ASCIIDOCTOR) -b pdf -a allow-uri-read -r asciidoctor-pdf $(SPEC).adoc -o $@

clean:
	-rm -f $(GENERATED) $(TARGETS)
